---
name: vulnerability-scanner
description: |
  Scan code for security vulnerabilities following OWASP guidelines.
  Identifies injection, XSS, auth issues, and other security risks.
---

# Vulnerability Scanner Skill

## Purpose
Identify security vulnerabilities in code before they reach production.

## OWASP Top 10 Checks

### A01: Broken Access Control

**What to look for:**
- Missing authorization checks
- IDOR (Insecure Direct Object References)
- Path traversal
- CORS misconfiguration

```typescript
// VULNERABLE: No authorization check
app.get('/api/users/:id', async (req, res) => {
  const user = await db.users.findById(req.params.id);
  res.json(user);  // Anyone can access any user!
});

// SECURE: Check authorization
app.get('/api/users/:id', authenticate, async (req, res) => {
  if (req.user.id !== req.params.id && req.user.role !== 'admin') {
    return res.status(403).json({ error: 'Forbidden' });
  }
  const user = await db.users.findById(req.params.id);
  res.json(user);
});
```

### A02: Cryptographic Failures

**What to look for:**
- Hardcoded secrets
- Weak encryption
- Sensitive data in logs
- Missing HTTPS

```typescript
// VULNERABLE: Hardcoded secret
const JWT_SECRET = 'my-secret-key';

// SECURE: Environment variable
const JWT_SECRET = process.env.JWT_SECRET;
if (!JWT_SECRET) throw new Error('JWT_SECRET required');

// VULNERABLE: Logging sensitive data
console.log('Login attempt:', { email, password });

// SECURE: Sanitize logs
console.log('Login attempt:', { email });
```

### A03: Injection

**What to look for:**
- SQL injection
- NoSQL injection
- Command injection
- LDAP injection

```typescript
// VULNERABLE: SQL injection
const query = `SELECT * FROM users WHERE email = '${email}'`;

// SECURE: Parameterized query
const query = 'SELECT * FROM users WHERE email = $1';
await db.query(query, [email]);

// VULNERABLE: Command injection
exec(`ls ${userInput}`);

// SECURE: Use safe methods
execFile('ls', [sanitize(userInput)]);

// With Prisma (safe by default)
const user = await prisma.user.findUnique({
  where: { email: email }  // Prisma handles escaping
});
```

### A04: Insecure Design

**What to look for:**
- Missing rate limiting
- No account lockout
- Weak password policies
- Missing security headers

```typescript
// VULNERABLE: No rate limiting on login
app.post('/api/auth/login', loginHandler);

// SECURE: Add rate limiting
import rateLimit from 'express-rate-limit';

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: 'Too many login attempts',
});

app.post('/api/auth/login', loginLimiter, loginHandler);
```

### A05: Security Misconfiguration

**What to look for:**
- Debug mode in production
- Default credentials
- Unnecessary features enabled
- Missing security headers

```typescript
// Add security headers
import helmet from 'helmet';
app.use(helmet());

// Disable X-Powered-By
app.disable('x-powered-by');

// Secure cookie settings
app.use(session({
  cookie: {
    secure: true,
    httpOnly: true,
    sameSite: 'strict',
  }
}));
```

### A06: Vulnerable Components

**Check for:**
```bash
# NPM audit
npm audit

# Fix automatically
npm audit fix

# Check for outdated packages
npm outdated
```

### A07: Authentication Failures

**What to look for:**
- Weak password requirements
- Missing MFA
- Session fixation
- Credential stuffing

```typescript
// VULNERABLE: Weak password validation
if (password.length < 6) { ... }

// SECURE: Strong password validation
const passwordSchema = z.string()
  .min(12, 'Password must be at least 12 characters')
  .regex(/[A-Z]/, 'Must contain uppercase letter')
  .regex(/[a-z]/, 'Must contain lowercase letter')
  .regex(/[0-9]/, 'Must contain number')
  .regex(/[^A-Za-z0-9]/, 'Must contain special character');
```

### A08: Data Integrity Failures

**What to look for:**
- Unsigned data
- Unverified downloads
- Insecure deserialization

### A09: Logging Failures

**What to look for:**
- Missing security event logging
- Sensitive data in logs
- Log injection

```typescript
// SECURE: Security event logging
const securityLogger = {
  loginAttempt: (email: string, success: boolean, ip: string) => {
    logger.info('auth.login', {
      email: hashEmail(email),
      success,
      ip,
      timestamp: new Date().toISOString(),
    });
  },
};
```

### A10: SSRF (Server-Side Request Forgery)

**What to look for:**
- User-controlled URLs
- Internal network access

```typescript
// VULNERABLE: User controls URL
const response = await fetch(userProvidedUrl);

// SECURE: Validate URL
const allowedDomains = ['api.trusted.com'];

function isAllowedUrl(url: string): boolean {
  try {
    const parsed = new URL(url);
    return allowedDomains.includes(parsed.hostname);
  } catch {
    return false;
  }
}

if (!isAllowedUrl(userProvidedUrl)) {
  throw new Error('Invalid URL');
}
```

## Security Scan Checklist

### Authentication
- [ ] Passwords hashed with bcrypt (12+ rounds)
- [ ] JWT secrets are strong (32+ chars)
- [ ] Tokens have appropriate expiry
- [ ] Refresh token rotation
- [ ] Account lockout after failed attempts

### Authorization
- [ ] All endpoints have auth checks
- [ ] Resource ownership verified
- [ ] Role-based access control
- [ ] Admin routes protected

### Input Validation
- [ ] All user input validated
- [ ] Parameterized queries used
- [ ] File uploads restricted
- [ ] Content-Type validated

### Output Encoding
- [ ] HTML escaped for XSS prevention
- [ ] JSON properly encoded
- [ ] No sensitive data in responses

### Session Management
- [ ] Secure cookie flags set
- [ ] Session timeout configured
- [ ] CSRF protection enabled

### Headers
- [ ] Security headers configured
- [ ] CORS properly restricted
- [ ] Content-Security-Policy set

## Vulnerability Report Format

```markdown
# Security Audit Report

## Executive Summary
Overall security posture and key findings.

## Critical Vulnerabilities ðŸ”´
| ID | Vulnerability | Location | Impact | Fix |
|----|---------------|----------|--------|-----|
| V1 | SQL Injection | users.ts:42 | High | Use parameterized queries |

## High-Risk Issues ðŸŸ 
...

## Medium-Risk Issues ðŸŸ¡
...

## Low-Risk Issues ðŸ”µ
...

## Recommendations
1. Immediate actions required
2. Short-term improvements
3. Long-term security roadmap
```

## Quality Checklist

- [ ] OWASP Top 10 addressed
- [ ] Input validation present
- [ ] Output encoding correct
- [ ] Auth/authz implemented
- [ ] Secrets not in code
- [ ] Dependencies audited
- [ ] Security headers set
- [ ] Logging doesn't leak data
